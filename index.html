<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Web Game Engine (Clean)</title>

<style>
body { margin:0; overflow:hidden; font-family:Arial; background:#1e1e1e }
#top {
  position:fixed; top:0; left:0; right:0; height:42px;
  background:#2d2d30; color:#ddd; display:flex; gap:6px;
  align-items:center; padding:0 8px; z-index:10
}
#left {
  position:fixed; top:42px; left:0; bottom:0; width:220px;
  background:#252526; color:#ccc; padding:8px; overflow:auto
}
#right {
  position:fixed; top:42px; right:0; bottom:0; width:300px;
  background:#252526; color:#ccc; padding:8px
}
button {
  background:#0e639c; border:none; color:white;
  padding:5px 8px; border-radius:3px; cursor:pointer
}
button:hover { background:#1177bb }
.item { padding:4px; cursor:pointer; border-radius:3px }
.item:hover { background:#333 }
.item.sel { background:#007acc }
input { width:100%; margin-bottom:4px }
textarea {
  width:100%; height:160px; background:#1e1e1e;
  color:#d4d4d4; border:1px solid #333; font-family:Consolas
}
h3 { margin:6px 0; font-size:13px; color:#9cdcfe }
</style>
</head>

<body>

<div id="top">
  <button onclick="addCube()">âž• Cube</button>
  <button onclick="saveScene()">ðŸ’¾ Save</button>
  <button onclick="loadScene()">ðŸ“‚ Load</button>
</div>

<div id="left">
  <h3>Workspace</h3>
  <div id="workspace"></div>
</div>

<div id="right">
  <h3>Inspector</h3>
  <div id="inspector"></div>

  <h3>Script</h3>
  <textarea id="script"></textarea>
  <button onclick="applyScript()">Apply Script</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>

<script>
/* ================= CORE ================= */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0,6,12);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);

/* ================= LIGHT ================= */
scene.add(new THREE.AmbientLight(0xffffff,0.5));
const sun = new THREE.DirectionalLight(0xffffff,1);
sun.position.set(20,30,10);
sun.castShadow = true;
scene.add(sun);

/* ================= BASEPLATE ================= */
const baseplate = new THREE.Mesh(
  new THREE.BoxGeometry(80,1,80),
  new THREE.MeshStandardMaterial({color:0x3a8f3a})
);
baseplate.position.y = -0.5;
baseplate.receiveShadow = true;
scene.add(baseplate);

/* ================= OBJECT SYSTEM ================= */
const objects = [];
let selected = null;

function addObject(mesh,name){
  mesh.castShadow = true;
  scene.add(mesh);
  const o = {
    name,
    mesh,
    scriptCode:"",
    scriptInstance:null
  };
  objects.push(o);
  refreshWorkspace();
  return o;
}

function addCube(){
  addObject(
    new THREE.Mesh(
      new THREE.BoxGeometry(1,1,1),
      new THREE.MeshStandardMaterial({color:0xff5555})
    ),
    "Cube"
  );
}

/* ================= WORKSPACE ================= */
function refreshWorkspace(){
  const w = document.getElementById("workspace");
  w.innerHTML = "";
  objects.forEach(o=>{
    const d = document.createElement("div");
    d.className = "item" + (o===selected?" sel":"");
    d.textContent = o.name;
    d.onclick = ()=>select(o);
    w.appendChild(d);
  });
}

function select(o){
  selected = o;
  refreshWorkspace();
  showInspector();
  document.getElementById("script").value = o.scriptCode;
}

/* ================= INSPECTOR ================= */
function showInspector(){
  if(!selected) return;
  const i = document.getElementById("inspector");
  const p = selected.mesh.position;
  const r = selected.mesh.rotation;
  const s = selected.mesh.scale;

  i.innerHTML = `
  X <input value="${p.x}" oninput="selected.mesh.position.x=this.value">
  Y <input value="${p.y}" oninput="selected.mesh.position.y=this.value">
  Z <input value="${p.z}" oninput="selected.mesh.position.z=this.value">
  RX <input value="${r.x}" oninput="selected.mesh.rotation.x=this.value">
  RY <input value="${r.y}" oninput="selected.mesh.rotation.y=this.value">
  RZ <input value="${r.z}" oninput="selected.mesh.rotation.z=this.value">
  S <input value="${s.x}" oninput="
    selected.mesh.scale.set(this.value,this.value,this.value)">
  `;
}

/* ================= SCRIPT SYSTEM ================= */
function applyScript(){
  if(!selected) return;
  const code = document.getElementById("script").value;

  try{
    if(selected.scriptInstance?.stop)
      selected.scriptInstance.stop();

    const ScriptClass = new Function(code+"; return Script;")();
    const inst = new ScriptClass(selected);
    selected.scriptInstance = inst;
    selected.scriptCode = code;

    if(inst.start) inst.start();
    if(inst.tick) inst.tick();

  }catch(e){
    alert(e.message);
  }
}

/* ================= SAVE / LOAD ================= */
function saveScene(){
  const data = objects.map(o=>({
    name:o.name,
    pos:o.mesh.position.toArray(),
    rot:o.mesh.rotation.toArray(),
    scale:o.mesh.scale.toArray(),
    script:o.scriptCode
  }));
  localStorage.setItem("scene",JSON.stringify(data));
  alert("Saved");
}

function loadScene(){
  const data = JSON.parse(localStorage.getItem("scene")||"[]");
  objects.forEach(o=>scene.remove(o.mesh));
  objects.length = 0;

  data.forEach(d=>{
    const o = addCube();
    o.name = d.name;
    o.mesh.position.fromArray(d.pos);
    o.mesh.rotation.fromArray(d.rot);
    o.mesh.scale.fromArray(d.scale);
    o.scriptCode = d.script;
    document.getElementById("script").value = d.script;
    select(o);
    if(d.script) applyScript();
  });
}

/* ================= CAMERA ================= */
let yaw=0,pitch=0,lock=false;
renderer.domElement.onclick=()=>renderer.domElement.requestPointerLock();
document.addEventListener("pointerlockchange",()=>lock=document.pointerLockElement);
addEventListener("mousemove",e=>{
  if(!lock) return;
  yaw-=e.movementX*0.002;
  pitch-=e.movementY*0.002;
  pitch=Math.max(-1.5,Math.min(1.5,pitch));
});
const keys={};
onkeydown=e=>keys[e.key]=true;
onkeyup=e=>keys[e.key]=false;

/* ================= LOOP ================= */
(function loop(){
  requestAnimationFrame(loop);
  camera.rotation.set(pitch,yaw,0,"YXZ");
  if(keys.w) camera.translateZ(-0.2);
  if(keys.s) camera.translateZ(0.2);
  if(keys.a) camera.translateX(-0.2);
  if(keys.d) camera.translateX(0.2);
  renderer.render(scene,camera);
})();
</script>

</body>
</html>
