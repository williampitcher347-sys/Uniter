<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Web Game Engine</title>
<style>
body { margin:0; overflow:hidden; background:#0e0e0e; font-family:Arial; }
#ui {
    position:fixed;
    top:10px; left:10px;
    background:rgba(15,15,15,0.95);
    padding:10px;
    color:white;
    border-radius:8px;
    width:240px;
}
button {
    width:100%;
    margin-top:6px;
    padding:6px;
    background:#2a7cff;
    border:none;
    color:white;
    cursor:pointer;
    border-radius:4px;
}
button:hover { background:#4c94ff; }
</style>
</head>
<body>

<div id="ui">
<b>Web Game Engine</b>
<button onclick="spawnCube()">Spawn Scripted Cube</button>
<button onclick="resetScene()">Reset Scene</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>

<script>
/* =====================
   ENGINE CORE
===================== */

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0e0e0e);

const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0, 3, 8);

const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(innerWidth, innerHeight);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
document.body.appendChild(renderer.domElement);

/* =====================
   REAL LIGHTING
===================== */

const sun = new THREE.DirectionalLight(0xffffff, 1.2);
sun.position.set(10, 20, 10);
sun.castShadow = true;
sun.shadow.mapSize.set(2048, 2048);
sun.shadow.camera.near = 1;
sun.shadow.camera.far = 50;
sun.shadow.camera.left = -20;
sun.shadow.camera.right = 20;
sun.shadow.camera.top = 20;
sun.shadow.camera.bottom = -20;
scene.add(sun);

scene.add(new THREE.AmbientLight(0x404040));

/* =====================
   PLATFORM
===================== */

const platform = new THREE.Mesh(
    new THREE.BoxGeometry(20, 1, 20),
    new THREE.MeshStandardMaterial({ color: 0x2b2b2b })
);
platform.position.y = -0.5;
platform.receiveShadow = true;
scene.add(platform);

/* =====================
   GAME OBJECT SYSTEM
===================== */

const gameObjects = [];

function createGameObject(mesh, script) {
    mesh.castShadow = true;
    mesh.receiveShadow = true;
    scene.add(mesh);

    const obj = {
        mesh,
        script,
        started:false
    };

    gameObjects.push(obj);
    return obj;
}

/* =====================
   SCRIPTING SYSTEM
===================== */

class SpinScript {
    start(obj) {}
    update(obj, dt) {
        obj.mesh.rotation.y += dt;
    }
}

/* =====================
   SPAWNING
===================== */

function spawnCube() {
    const cube = new THREE.Mesh(
        new THREE.BoxGeometry(1,1,1),
        new THREE.MeshStandardMaterial({ color: Math.random()*0xffffff })
    );
    cube.position.set(
        Math.random()*6 - 3,
        1,
        Math.random()*6 - 3
    );

    createGameObject(cube, new SpinScript());
}

function resetScene() {
    gameObjects.forEach(o => scene.remove(o.mesh));
    gameObjects.length = 0;
}

/* =====================
   CAMERA CONTROLS
===================== */

let keys = {};
let yaw = 0, pitch = 0;

addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

addEventListener("click", () => document.body.requestPointerLock());
addEventListener("mousemove", e => {
    if (document.pointerLockElement) {
        yaw -= e.movementX * 0.002;
        pitch -= e.movementY * 0.002;
        pitch = Math.max(-1.5, Math.min(1.5, pitch));
    }
});

/* =====================
   GAME LOOP
===================== */

let lastTime = performance.now();

function loop(time) {
    requestAnimationFrame(loop);
    const dt = (time - lastTime) / 1000;
    lastTime = time;

    camera.rotation.order = "YXZ";
    camera.rotation.y = yaw;
    camera.rotation.x = pitch;

    const speed = 6 * dt;
    if (keys["w"]) camera.translateZ(-speed);
    if (keys["s"]) camera.translateZ(speed);
    if (keys["a"]) camera.translateX(-speed);
    if (keys["d"]) camera.translateX(speed);

    for (const obj of gameObjects) {
        if (!obj.started) {
            obj.script?.start(obj);
            obj.started = true;
        }
        obj.script?.update(obj, dt);
    }

    renderer.render(scene, camera);
}

loop(lastTime);

/* =====================
   RESIZE
===================== */

addEventListener("resize", () => {
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
});
</script>
</body>
</html>
