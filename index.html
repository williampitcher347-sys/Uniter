<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Web Engine v3</title>

<style>
body { margin:0; overflow:hidden; background:#1e1e1e; color:#ccc; font-family:Consolas }
#topbar {
  position:fixed; top:0; left:0; right:0; height:40px;
  background:#2d2d30; display:flex; gap:6px; padding:6px; z-index:10;
}
button { background:#0e639c; border:none; color:white; padding:5px 8px; cursor:pointer }
button:hover { background:#1177bb }

#left { position:fixed; top:40px; left:0; bottom:0; width:220px; background:#252526; padding:6px }
#right { position:fixed; top:40px; right:0; bottom:0; width:360px; background:#252526; padding:6px; overflow:auto }

.item { padding:4px; cursor:pointer }
.item.sel { background:#007acc }

h3 { color:#9cdcfe; margin:6px 0 }
input, textarea {
  width:100%; background:#1e1e1e; color:#ccc;
  border:1px solid #333; margin-bottom:4px;
}
textarea { height:200px }
.comp { border:1px solid #333; padding:4px; margin-bottom:6px }
.plus { cursor:pointer; color:#0af }
</style>
</head>

<body>

<div id="topbar">
  <button onclick="addCube()">➕ Cube</button>
  <button onclick="play()">▶ Play</button>
  <button onclick="stop()">⏹ Stop</button>
  <span id="mode">Editor</span>
</div>

<div id="left">
  <h3>Hierarchy</h3>
  <div id="hierarchy"></div>
</div>

<div id="right">
  <h3>Inspector</h3>
  <div id="inspector"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>

<script>
/* ================= CORE ================= */

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0,6,12);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff,0.4));
const sun = new THREE.DirectionalLight(0xffffff,1);
sun.position.set(20,30,10);
scene.add(sun);

/* ================= OBJECT SYSTEM ================= */

const objects=[];
let selected=null;
let playing=false;

function makeObject(mesh,name){
  scene.add(mesh);
  const o={
    name,
    mesh,
    components:{
      transform:true
    },
    script:null
  };
  objects.push(o);
  select(o);
  refreshHierarchy();
}

function addCube(){
  makeObject(new THREE.Mesh(
    new THREE.BoxGeometry(1,1,1),
    new THREE.MeshStandardMaterial({color:0xff5555})
  ),"Cube");
}
addCube();

/* ================= UI ================= */

function refreshHierarchy(){
  const h=document.getElementById("hierarchy");
  h.innerHTML="";
  objects.forEach(o=>{
    const d=document.createElement("div");
    d.className="item"+(o===selected?" sel":"");
    d.textContent=o.name;
    d.onclick=()=>select(o);
    h.appendChild(d);
  });
}

function select(o){
  selected=o;
  refreshHierarchy();
  refreshInspector();
}

/* ================= INSPECTOR ================= */

function refreshInspector(){
  const i=document.getElementById("inspector");
  if(!selected){ i.innerHTML=""; return; }

  const m=selected.mesh;
  i.innerHTML=`
<div class="comp">
<b>Transform</b><br>
X <input value="${m.position.x}" onchange="m.position.x=this.value">
Y <input value="${m.position.y}" onchange="m.position.y=this.value">
Z <input value="${m.position.z}" onchange="m.position.z=this.value">
</div>

<div class="comp">
<b>Components</b>
<div class="plus" onclick="addScript()">➕ Add Script</div>
</div>
`;

  if(selected.script){
    i.innerHTML+=`
<div class="comp">
<b>Script</b>
<textarea id="script">${selected.script.code}</textarea>
<button onclick="applyScript()">Apply</button>
</div>
`;
  }
}

/* ================= SCRIPT COMPONENT ================= */

function addScript(){
  selected.script={
    code:`class Script {
  editorUpdate(o, dt){
    // runs in editor
  }

  update(o, dt){
    // runs in play
  }
}`
  };
  refreshInspector();
}

function applyScript(){
  selected.script.code=document.getElementById("script").value;
  try{
    selected.script.instance=
      new Function("camera",selected.script.code+";return Script;")(camera);
  }catch(e){console.error(e);}
}

/* ================= EDITOR + PLAY LOOP ================= */

function play(){
  playing=true;
  document.getElementById("mode").textContent="Play";
}

function stop(){
  playing=false;
  document.getElementById("mode").textContent="Editor";
}

let last=performance.now();
(function loop(t){
  requestAnimationFrame(loop);
  const dt=(t-last)/1000; last=t;

  objects.forEach(o=>{
    if(o.script?.instance){
      if(!playing) o.script.instance.editorUpdate?.(o,dt);
      if(playing) o.script.instance.update?.(o,dt);
    }
  });

  renderer.render(scene,camera);
})();
</script>

</body>
</html>
