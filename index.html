<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Web 3D Engine</title>
<style>
body { margin:0; overflow:hidden; background:#1e1e1e; font-family:monospace }
#topbar {
  position:fixed; top:0; left:0; right:0;
  height:36px; background:#2d2d2d;
  color:white; display:flex; align-items:center;
  padding:0 10px; z-index:10;
}
#workspace {
  position:fixed; top:36px; left:0;
  width:220px; bottom:40%;
  background:#252526; color:white;
  overflow:auto; padding:6px;
}
#editor {
  position:fixed; bottom:0; left:0; right:0;
  height:40%; background:#1e1e1e;
  display:flex; flex-direction:column;
}
textarea {
  flex:1; background:#1e1e1e;
  color:#d4d4d4; border:none;
  padding:10px; font-size:14px;
}
button { background:#0e639c; color:white; border:none; padding:5px 10px; cursor:pointer }
#canvas {
  position:fixed; top:36px; left:220px;
  right:0; bottom:40%;
}
</style>
</head>
<body>

<div id="topbar">
  <button onclick="run()">â–¶ Run Script</button>
  <input type="file" id="file" accept=".gltf,.glb">
  <span style="margin-left:10px">M = Lock / Unlock Mouse</span>
</div>

<div id="workspace"><b>Workspace</b><div id="items"></div></div>

<div id="canvas"></div>

<div id="editor">
<textarea id="code">
// Engine Script
camera.position.set(0, 6, 12);
camera.lookAt(0,0,0);

// Example block
new Block(0, 1, 0, 3, 1, 3, 0x3a8f3a);
</textarea>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
let scene, camera, renderer;
let locked = false;
const objects = [];
const keys = {};

scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);

renderer = new THREE.WebGLRenderer({antialias:true});
document.getElementById("canvas").appendChild(renderer.domElement);

function resize(){
  const c = document.getElementById("canvas");
  renderer.setSize(c.clientWidth, c.clientHeight);
  camera.aspect = c.clientWidth / c.clientHeight;
  camera.updateProjectionMatrix();
}
addEventListener("resize", resize);
resize();

/* LIGHT */
scene.add(new THREE.AmbientLight(0xffffff, 0.6));
const sun = new THREE.DirectionalLight(0xffffff, 1);
sun.position.set(20,30,10);
scene.add(sun);

/* BASEPLATE */
new THREE.Mesh(
  new THREE.BoxGeometry(50,1,50),
  new THREE.MeshStandardMaterial({color:0x3a8f3a})
).position.y = -0.5;

/* API */
class Block {
  constructor(x,y,z,w,h,d,color){
    const m = new THREE.Mesh(
      new THREE.BoxGeometry(w,h,d),
      new THREE.MeshStandardMaterial({color})
    );
    m.position.set(x,y,z);
    scene.add(m);
    objects.push(m);
    updateWorkspace();
    return m;
  }
}

function updateWorkspace(){
  const list = document.getElementById("items");
  list.innerHTML = "";
  objects.forEach((o,i)=>{
    const d = document.createElement("div");
    d.textContent = "Object " + i;
    list.appendChild(d);
  });
}

/* SCRIPT RUN */
function run(){
  objects.forEach(o=>scene.remove(o));
  objects.length = 0;
  try { new Function(code.value)(); }
  catch(e){ alert(e.message); }
}

/* CAMERA MOVE */
addEventListener("keydown", e=>keys[e.key.toLowerCase()]=true);
addEventListener("keyup", e=>keys[e.key.toLowerCase()]=false);

addEventListener("mousemove", e=>{
  if(!locked) return;
  camera.rotation.y -= e.movementX * 0.002;
  camera.rotation.x -= e.movementY * 0.002;
});

addEventListener("keydown", e=>{
  if(e.key.toLowerCase()==="m"){
    locked = !locked;
    document.body.requestPointerLock();
    if(!locked) document.exitPointerLock();
  }
});

/* MODEL UPLOAD */
file.onchange = ()=>{
  const loader = new THREE.GLTFLoader();
  loader.load(URL.createObjectURL(file.files[0]), gltf=>{
    scene.add(gltf.scene);
    objects.push(gltf.scene);
    updateWorkspace();
  });
};

/* LOOP */
function loop(){
  requestAnimationFrame(loop);
  const s = 0.3;
  if(keys.w) camera.translateZ(-s);
  if(keys.s) camera.translateZ(s);
  if(keys.a) camera.translateX(-s);
  if(keys.d) camera.translateX(s);
  if(keys.q) camera.translateY(-s);
  if(keys.e) camera.translateY(s);
  renderer.render(scene, camera);
}
loop();
</script>
</body>
</html>
