<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Code Engine v2</title>
<style>
html,body { margin:0; height:100%; overflow:hidden; background:#1e1e1e; }
#ui {
  position:fixed; top:0; left:0; right:0;
  height:40px; background:#2d2d2d;
  display:flex; align-items:center; gap:8px;
  padding:0 10px; color:white; font-family:monospace;
}
#workspace {
  position:fixed; top:40px; left:0; bottom:35%;
  width:220px; background:#252526;
  color:white; font-family:monospace;
  padding:6px; overflow:auto;
}
#viewport {
  position:fixed; top:40px; left:220px;
  right:0; bottom:35%;
}
#editor {
  position:fixed; left:0; right:0; bottom:0;
  height:35%; background:#1e1e1e;
}
textarea {
  width:100%; height:100%;
  background:#1e1e1e; color:#d4d4d4;
  border:none; padding:10px;
  font-family:monospace; font-size:14px;
}
button { background:#0e639c; color:white; border:none; padding:5px 10px; }
</style>
</head>
<body>

<div id="ui">
  <button onclick="run()">â–¶ Run</button>
  <input type="file" id="file" accept=".glb,.gltf">
  <span id="lock">Mouse: UNLOCKED (M)</span>
</div>

<div id="workspace"><b>Workspace</b><div id="list"></div></div>
<div id="viewport"></div>

<div id="editor">
<textarea id="code">
// Scene script
camera.position.set(0,6,12);
camera.lookAt(0,0,0);

// Baseplate
new Block("Baseplate", 0,-0.5,0, 40,1,40, 0x3a8f3a);

// Test cube
new Block("Cube", 0,2,0, 2,2,2, 0xff4444);
</textarea>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
/* ---------- ENGINE CORE ---------- */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

const camera = new THREE.PerspectiveCamera(75,1,0.1,1000);

const renderer = new THREE.WebGLRenderer({antialias:true});
document.getElementById("viewport").appendChild(renderer.domElement);

function resize(){
  const v = document.getElementById("viewport");
  renderer.setSize(v.clientWidth, v.clientHeight);
  camera.aspect = v.clientWidth / v.clientHeight;
  camera.updateProjectionMatrix();
}
addEventListener("resize", resize);
resize();

/* LIGHT */
scene.add(new THREE.AmbientLight(0xffffff,0.6));
const sun = new THREE.DirectionalLight(0xffffff,1);
sun.position.set(20,30,10);
scene.add(sun);

/* ---------- WORKSPACE ---------- */
const workspace = [];
function refreshWorkspace(){
  const l = document.getElementById("list");
  l.innerHTML = "";
  workspace.forEach(o=>{
    const d = document.createElement("div");
    d.textContent = o.name;
    l.appendChild(d);
  });
}

/* ---------- API ---------- */
class Block {
  constructor(name,x,y,z,w,h,d,color){
    const m = new THREE.Mesh(
      new THREE.BoxGeometry(w,h,d),
      new THREE.MeshStandardMaterial({color})
    );
    m.position.set(x,y,z);
    m.name = name;
    scene.add(m);
    workspace.push(m);
    refreshWorkspace();
    return m;
  }
}

/* ---------- SCRIPT RUN ---------- */
function run(){
  workspace.forEach(o=>scene.remove(o));
  workspace.length = 0;
  try { new Function(code.value)(); }
  catch(e){ alert(e.message); }
}

/* ---------- CAMERA CONTROLS ---------- */
const keys = {};
let locked = false;

addEventListener("keydown", e=>{
  keys[e.key.toLowerCase()] = true;
  if(e.key==="m"){
    locked = !locked;
    document.getElementById("lock").textContent =
      "Mouse: " + (locked?"LOCKED":"UNLOCKED") + " (M)";
    locked ? document.body.requestPointerLock() : document.exitPointerLock();
  }
});
addEventListener("keyup", e=>keys[e.key.toLowerCase()] = false);

addEventListener("mousemove", e=>{
  if(!locked) return;
  camera.rotation.y -= e.movementX * 0.002;
  camera.rotation.x -= e.movementY * 0.002;
});

function camMove(){
  const s = 0.25;
  if(keys.w) camera.translateZ(-s);
  if(keys.s) camera.translateZ(s);
  if(keys.a) camera.translateX(-s);
  if(keys.d) camera.translateX(s);
  if(keys.q) camera.translateY(-s);
  if(keys.e) camera.translateY(s);
}

/* ---------- MODEL UPLOAD ---------- */
file.onchange = ()=>{
  const loader = new THREE.GLTFLoader();
  loader.load(URL.createObjectURL(file.files[0]), g=>{
    g.scene.name = file.files[0].name;
    scene.add(g.scene);
    workspace.push(g.scene);
    refreshWorkspace();
    alert("Model Loaded");
  });
};

/* ---------- LOOP ---------- */
function loop(){
  requestAnimationFrame(loop);
  camMove();
  renderer.render(scene, camera);
}
run();
loop();
</script>
</body>
</html>
