<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Web Game Engine</title>
<style>
body{margin:0;overflow:hidden;font-family:Arial;background:#000}

/* TOP BAR */
#topbar{
 position:fixed;top:0;left:0;right:0;height:40px;
 background:#1b1b1b;color:white;
 display:flex;align-items:center;padding:0 10px;z-index:10
}

/* LEFT */
#workspacePanel{
 position:fixed;top:40px;left:0;width:220px;bottom:100px;
 background:#141414;color:white;padding:6px;overflow:auto
}
.item{padding:4px;cursor:pointer}
.item.sel{background:#2a7cff}

/* RIGHT */
#scriptPanel{
 position:fixed;top:40px;right:0;width:320px;bottom:100px;
 background:#141414;color:white;padding:6px
}
textarea{
 width:100%;height:100%;background:#0e0e0e;color:#0f0;
 border:1px solid #333;font-family:monospace;font-size:12px
}

/* BOTTOM BAR */
#bottombar{
 position:fixed;left:0;right:0;bottom:0;height:100px;
 background:#1b1b1b;color:white;
 display:flex;align-items:center;justify-content:center;gap:10px
}
.tool{padding:10px 14px;background:#333;cursor:pointer}
.tool.active{background:#2a7cff}

/* SHORTCUTS */
#shortcuts{
 position:fixed;bottom:110px;left:10px;
 background:rgba(20,20,20,.9);
 color:#aaa;font-size:12px;
 padding:8px;border-radius:6px
}

button{background:#2a7cff;border:0;color:white;padding:6px 10px;border-radius:4px}
</style>
</head>
<body>

<div id="topbar">
 <button onclick="play()">▶ Play</button>
 <button onclick="stop()">⏹ Stop</button>
 <span style="margin-left:10px" id="mouseState">Mouse: Unlocked (M)</span>
</div>

<div id="workspacePanel">
 <b>Workspace</b>
 <div id="workspace"></div>
</div>

<div id="scriptPanel">
 <b>Script</b>
 <textarea id="code">
class Script{
 start(o){}
 update(o,dt){}
}
 </textarea>
</div>

<div id="bottombar">
 <div class="tool active" onclick="setTool('move')">Move</div>
 <div class="tool" onclick="setTool('rotate')">Rotate</div>
 <div class="tool" onclick="setTool('scale')">Scale</div>
</div>

<div id="shortcuts">
<b>Shortcuts</b><br>
WASD – Move Camera<br>
Right Click – Look<br>
Click – Select Object<br>
Q / E – Down / Up<br>
M – Lock / Unlock Mouse
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>

<script>
/* SCENE */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87a0c0);

/* CAMERA */
const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,.1,1000);
camera.position.set(0,6,10);

/* RENDERER */
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.shadowMap.enabled=true;
document.body.appendChild(renderer.domElement);

/* LIGHT */
const sun=new THREE.DirectionalLight(0xffffff,1.2);
sun.position.set(10,20,10);
sun.castShadow=true;
scene.add(sun);
scene.add(new THREE.AmbientLight(0x404040));

/* PLATFORM */
const platform=new THREE.Mesh(
 new THREE.BoxGeometry(40,1,40),
 new THREE.MeshStandardMaterial({color:0x2d2d2d})
);
platform.position.y=-.5;
platform.receiveShadow=true;
scene.add(platform);

/* OBJECTS */
const objects=[];
let selected=null;
let playing=false;

/* ADD OBJECT */
function addCube(){
 const mesh=new THREE.Mesh(
  new THREE.BoxGeometry(),
  new THREE.MeshStandardMaterial({color:Math.random()*0xffffff})
 );
 mesh.position.y=1;
 mesh.castShadow=true;
 scene.add(mesh);
 const o={mesh,script:null,code:"",started:false};
 objects.push(o);
 refresh();
}
addCube();

/* WORKSPACE */
function refresh(){
 const w=document.getElementById("workspace");
 w.innerHTML="";
 objects.forEach(o=>{
  const d=document.createElement("div");
  d.className="item"+(o===selected?" sel":"");
  d.textContent="GameObject";
  d.onclick=()=>select(o);
  w.appendChild(d);
 });
}
function select(o){
 selected=o;
 document.getElementById("code").value=o.code||document.getElementById("code").value;
 refresh();
}

/* SCRIPT */
function applyScript(){
 if(!selected)return;
 const c=document.getElementById("code").value;
 const C=new Function(c+";return Script;")();
 selected.script=new C();
 selected.code=c;
 selected.started=false;
}

/* CAMERA CONTROLS */
let keys={},yaw=0,pitch=0;
let mouseLocked=false;
addEventListener("keydown",e=>{
 keys[e.key.toLowerCase()]=true;
 if(e.key.toLowerCase()==="m"){
  toggleMouse();
 }
});
addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

function toggleMouse(){
 if(mouseLocked){
  document.exitPointerLock();
  mouseLocked=false;
 }else{
  renderer.domElement.requestPointerLock();
  mouseLocked=true;
 }
 document.getElementById("mouseState").textContent=
  "Mouse: "+(mouseLocked?"Locked":"Unlocked")+" (M)";
}

addEventListener("mousemove",e=>{
 if(mouseLocked && !playing){
  yaw-=e.movementX*0.002;
  pitch=Math.max(-1.5,Math.min(1.5,pitch-e.movementY*0.002));
 }
});

/* SELECTION */
const raycaster=new THREE.Raycaster();
const mouse=new THREE.Vector2();
renderer.domElement.addEventListener("mousedown",e=>{
 if(playing||mouseLocked&&e.button===2)return;
 mouse.x=(e.clientX/innerWidth)*2-1;
 mouse.y=-(e.clientY/innerHeight)*2+1;
 raycaster.setFromCamera(mouse,camera);
 const hits=raycaster.intersectObjects(objects.map(o=>o.mesh));
 if(hits.length){
  if(selected)selected.mesh.material.emissive?.set(0x000000);
  selected=objects.find(o=>o.mesh===hits[0].object);
  selected.mesh.material.emissive=new THREE.Color(0x222222);
  refresh();
 }
});

/* PLAY MODE */
function play(){ playing=true; applyScript(); }
function stop(){ playing=false; }

/* LOOP */
let last=performance.now();
(function loop(t){
 requestAnimationFrame(loop);
 const dt=(t-last)/1000;last=t;

 camera.rotation.order="YXZ";
 camera.rotation.set(pitch,yaw,0);

 if(!playing){
  const sp=10*dt;
  if(keys.w)camera.translateZ(-sp);
  if(keys.s)camera.translateZ(sp);
  if(keys.a)camera.translateX(-sp);
  if(keys.d)camera.translateX(sp);
  if(keys.q)camera.position.y-=sp;
  if(keys.e)camera.position.y+=sp;
 }

 if(playing){
  objects.forEach(o=>{
   if(o.script){
    if(!o.started){o.script.start?.(o);o.started=true}
    o.script.update?.(o,dt);
   }
  });
 }

 renderer.render(scene,camera);
})();
addEventListener("resize",()=>{
 camera.aspect=innerWidth/innerHeight;
 camera.updateProjectionMatrix();
 renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
