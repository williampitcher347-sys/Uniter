<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Web Engine V4 Large Build</title>

<style>
/* ===================== GLOBAL ===================== */
body {
  margin:0;
  overflow:hidden;
  font-family:Arial, Helvetica, sans-serif;
  background:#1e1e1e;
}

/* ===================== TOP BAR ===================== */
#topbar {
  position:fixed;
  top:0; left:0; right:0;
  height:42px;
  background:#2d2d30;
  color:#ddd;
  display:flex;
  align-items:center;
  gap:8px;
  padding:0 10px;
  z-index:10;
}

/* ===================== LEFT ===================== */
#left {
  position:fixed;
  top:42px; left:0; bottom:0;
  width:240px;
  background:#252526;
  color:#ccc;
  padding:8px;
  overflow:auto;
}

/* ===================== RIGHT ===================== */
#right {
  position:fixed;
  top:42px; right:0; bottom:0;
  width:320px;
  background:#252526;
  color:#ccc;
  padding:8px;
  overflow:auto;
}

/* ===================== UI ===================== */
h3 {
  margin:6px 0;
  font-size:13px;
  color:#9cdcfe;
}

button {
  background:#0e639c;
  border:none;
  color:white;
  padding:6px 10px;
  border-radius:3px;
  cursor:pointer;
}
button:hover { background:#1177bb }

.item {
  padding:5px;
  border-radius:4px;
  cursor:pointer;
}
.item:hover { background:#333 }
.item.sel { background:#007acc }

label {
  font-size:11px;
  color:#aaa;
}

input {
  width:100%;
  margin-bottom:4px;
  background:#1e1e1e;
  color:#ddd;
  border:1px solid #333;
}

textarea {
  width:100%;
  height:180px;
  background:#1e1e1e;
  color:#d4d4d4;
  border:1px solid #333;
  font-family:Consolas, monospace;
  font-size:12px;
}

.script-btn {
  background:#3a3d41;
  margin-top:4px;
}
.script-btn:hover { background:#505357 }
</style>
</head>

<body>

<!-- ===================== TOP BAR ===================== -->
<div id="topbar">
  <button onclick="Engine.createCube()">âž• Cube</button>
  <button onclick="Engine.save()">ðŸ’¾ Save</button>
  <button onclick="Engine.load()">ðŸ“‚ Load</button>
  <span style="opacity:.6">Editor Mode</span>
</div>

<!-- ===================== LEFT ===================== -->
<div id="left">
  <h3>Workspace</h3>
  <div id="workspace"></div>
</div>

<!-- ===================== RIGHT ===================== -->
<div id="right">
  <h3>Inspector</h3>
  <div id="inspector"></div>

  <h3>Scripts</h3>
  <div id="scripts"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>

<script>
/* ====================================================
   ENGINE CORE
==================================================== */
const Engine = {
  scene: null,
  camera: null,
  renderer: null,
  objects: [],
  selected: null,

  init() {
    /* ---------- Scene ---------- */
    this.scene = new THREE.Scene();
    this.scene.background = new THREE.Color(0x87ceeb);

    /* ---------- Camera ---------- */
    this.camera = new THREE.PerspectiveCamera(
      70,
      innerWidth / innerHeight,
      0.1,
      1000
    );
    this.camera.position.set(0, 6, 12);

    /* ---------- Renderer ---------- */
    this.renderer = new THREE.WebGLRenderer({ antialias:true });
    this.renderer.setSize(innerWidth, innerHeight);
    this.renderer.shadowMap.enabled = true;
    document.body.appendChild(this.renderer.domElement);

    /* ---------- Lighting ---------- */
    this.scene.add(new THREE.AmbientLight(0xffffff, 0.5));
    const sun = new THREE.DirectionalLight(0xffffff, 1);
    sun.position.set(20, 30, 10);
    sun.castShadow = true;
    this.scene.add(sun);

    /* ---------- Baseplate ---------- */
    const base = new THREE.Mesh(
      new THREE.BoxGeometry(80, 1, 80),
      new THREE.MeshStandardMaterial({ color:0x3a8f3a })
    );
    base.position.y = -0.5;
    base.receiveShadow = true;
    this.scene.add(base);

    /* ---------- Input ---------- */
    Input.init(this.camera, this.renderer.domElement);

    /* ---------- Loop ---------- */
    this.loop();
  },

  loop() {
    requestAnimationFrame(() => this.loop());
    Input.update();
    ScriptSystem.updateAll();
    this.renderer.render(this.scene, this.camera);
  },

  /* ---------- Object Creation ---------- */
  createCube() {
    const mesh = new THREE.Mesh(
      new THREE.BoxGeometry(1,1,1),
      new THREE.MeshStandardMaterial({ color:0xff5555 })
    );
    mesh.castShadow = true;
    this.scene.add(mesh);

    const obj = {
      id: crypto.randomUUID(),
      name: "Cube",
      mesh,
      scripts: []
    };

    this.objects.push(obj);
    UI.refreshWorkspace();
    return obj;
  },

  /* ---------- Save / Load ---------- */
  save() {
    const data = this.objects.map(o => ({
      name: o.name,
      pos: o.mesh.position.toArray(),
      rot: o.mesh.rotation.toArray(),
      scale: o.mesh.scale.toArray(),
      scripts: o.scripts.map(s => s.code)
    }));
    localStorage.setItem("ENGINE_SCENE", JSON.stringify(data));
    alert("Scene saved");
  },

  load() {
    const raw = localStorage.getItem("ENGINE_SCENE");
    if (!raw) return;

    this.objects.forEach(o => this.scene.remove(o.mesh));
    this.objects.length = 0;

    const data = JSON.parse(raw);
    data.forEach(d => {
      const o = this.createCube();
      o.name = d.name;
      o.mesh.position.fromArray(d.pos);
      o.mesh.rotation.fromArray(d.rot);
      o.mesh.scale.fromArray(d.scale);

      d.scripts.forEach(code => {
        ScriptSystem.addScript(o, code);
      });
    });

    UI.refreshWorkspace();
  }
};

/* ====================================================
   INPUT SYSTEM
==================================================== */
const Input = {
  keys:{},
  yaw:0,
  pitch:0,
  locked:false,
  cam:null,

  init(cam, dom) {
    this.cam = cam;
    dom.onclick = () => dom.requestPointerLock();

    document.addEventListener("pointerlockchange", () => {
      this.locked = document.pointerLockElement === dom;
    });

    addEventListener("mousemove", e => {
      if (!this.locked) return;
      this.yaw -= e.movementX * 0.002;
      this.pitch -= e.movementY * 0.002;
      this.pitch = Math.max(-1.5, Math.min(1.5, this.pitch));
    });

    onkeydown = e => this.keys[e.key.toLowerCase()] = true;
    onkeyup   = e => this.keys[e.key.toLowerCase()] = false;
  },

  update() {
    this.cam.rotation.set(this.pitch, this.yaw, 0, "YXZ");
    if (this.keys.w) this.cam.translateZ(-0.2);
    if (this.keys.s) this.cam.translateZ(0.2);
    if (this.keys.a) this.cam.translateX(-0.2);
    if (this.keys.d) this.cam.translateX(0.2);
  }
};

/* ====================================================
   SCRIPT SYSTEM (ROBLOX-STYLE)
==================================================== */
const ScriptSystem = {
  addScript(object, code) {
    try {
      const ScriptClass = new Function(code + "; return Script;")();
      const instance = new ScriptClass(object);

      const scriptObj = {
        instance,
        code
      };

      object.scripts.push(scriptObj);

      if (instance.start) instance.start();
      if (instance.tick) instance.tick();

      UI.refreshScripts();
    } catch (e) {
      alert(e.message);
    }
  },

  updateAll() {
    Engine.objects.forEach(o => {
      o.scripts.forEach(s => {
        if (s.instance.update) {
          s.instance.update(1/60);
        }
      });
    });
  }
};

/* ====================================================
   UI SYSTEM
==================================================== */
const UI = {
  refreshWorkspace() {
    const w = document.getElementById("workspace");
    w.innerHTML = "";

    Engine.objects.forEach(o => {
      const d = document.createElement("div");
      d.className = "item" + (o === Engine.selected ? " sel":"");
      d.textContent = o.name;
      d.onclick = () => this.select(o);
      w.appendChild(d);
    });
  },

  select(o) {
    Engine.selected = o;
    this.refreshWorkspace();
    this.refreshInspector();
    this.refreshScripts();
  },

  refreshInspector() {
    const i = document.getElementById("inspector");
    const o = Engine.selected;
    if (!o) { i.innerHTML = ""; return; }

    const p=o.mesh.position, r=o.mesh.rotation, s=o.mesh.scale;
    i.innerHTML = `
      <label>Position</label>
      <input value="${p.x}" oninput="Engine.selected.mesh.position.x=this.value">
      <input value="${p.y}" oninput="Engine.selected.mesh.position.y=this.value">
      <input value="${p.z}" oninput="Engine.selected.mesh.position.z=this.value">

      <label>Rotation</label>
      <input value="${r.x}" oninput="Engine.selected.mesh.rotation.x=this.value">
      <input value="${r.y}" oninput="Engine.selected.mesh.rotation.y=this.value">
      <input value="${r.z}" oninput="Engine.selected.mesh.rotation.z=this.value">

      <label>Scale</label>
      <input value="${s.x}" oninput="
        Engine.selected.mesh.scale.set(this.value,this.value,this.value)">
    `;
  },

  refreshScripts() {
    const s = document.getElementById("scripts");
    const o = Engine.selected;
    s.innerHTML = "";

    if (!o) return;

    o.scripts.forEach((sc, idx) => {
      const btn = document.createElement("button");
      btn.className = "script-btn";
      btn.textContent = "Script " + (idx+1);
      btn.onclick = () => {
        const code = prompt("Edit Script", sc.code);
        if (code !== null) {
          sc.code = code;
          ScriptSystem.addScript(o, code);
        }
      };
      s.appendChild(btn);
    });

    const add = document.createElement("button");
    add.textContent = "+ Add Script";
    add.onclick = () => {
      const code = prompt("Script Code",
`class Script {
  constructor(o){ this.o=o; this.h=Math.random(); }
  tick(){
    this.h+=0.01;
    if(this.h>1)this.h=0;
    this.o.mesh.material.color.setHSL(this.h,1,0.5);
    requestAnimationFrame(()=>this.tick());
  }
}`);
      if (code) ScriptSystem.addScript(o, code);
    };
    s.appendChild(add);
  }
};

/* ====================================================
   START ENGINE
==================================================== */
Engine.init();
</script>

</body>
</html>
