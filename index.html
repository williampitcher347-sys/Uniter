<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Web Game Engine</title>

<style>
body {
  margin:0;
  overflow:hidden;
  font-family: Arial, Helvetica, sans-serif;
  background:#1e1e1e;
}

/* TOP BAR */
#topbar {
  position:fixed;
  top:0; left:0; right:0;
  height:42px;
  background:#2d2d30;
  color:#ddd;
  display:flex;
  align-items:center;
  gap:8px;
  padding:0 10px;
  z-index:10;
}

/* LEFT PANEL */
#left {
  position:fixed;
  top:42px; left:0; bottom:0;
  width:220px;
  background:#252526;
  color:#ccc;
  padding:8px;
  overflow:auto;
}

/* RIGHT PANEL */
#right {
  position:fixed;
  top:42px; right:0; bottom:0;
  width:340px;
  background:#252526;
  color:#ccc;
  padding:8px;
}

/* SHORTCUT PANEL */
#shortcuts {
  position:fixed;
  bottom:10px; left:10px;
  background:rgba(37,37,38,0.95);
  color:#ccc;
  padding:10px;
  border-radius:6px;
  font-size:12px;
  line-height:1.6;
}

/* UI */
h3 { margin:6px 0; font-size:13px; color:#9cdcfe; }

.item {
  padding:5px;
  border-radius:4px;
  cursor:pointer;
}
.item:hover { background:#333; }
.item.sel { background:#007acc; }

textarea {
  width:100%;
  height:220px;
  background:#1e1e1e;
  color:#d4d4d4;
  border:1px solid #333;
  font-family: Consolas, monospace;
  font-size:12px;
}

button {
  background:#0e639c;
  border:none;
  color:white;
  padding:6px 10px;
  border-radius:3px;
  cursor:pointer;
}
button:hover { background:#1177bb; }
</style>
</head>

<body>

<div id="topbar">
  <button onclick="play()">‚ñ∂ Play</button>
  <button onclick="stop()">‚èπ Stop</button>
  <button onclick="addCube()">‚ûï Cube</button>
  <button onclick="addSphere()">‚ûï Sphere</button>
  <button onclick="deleteSelected()">üóë Delete</button>
  <button onclick="resetCamera()">üé• Reset Camera</button>
  <input type="file" id="upload" accept=".glb,.gltf">
  <span id="mode">Editor</span>
</div>

<div id="left">
  <h3>Workspace</h3>
  <div id="workspace"></div>
</div>

<div id="right">
  <h3>Script (JavaScript)</h3>
  <div style="font-size:12px;color:#aaa">Attached Script: Script</div>
  <textarea id="script">
class Script {
  start(o) {
    console.log("Started:", o.name);
  }
  update(o, dt) {
    o.mesh.rotation.y += dt;
  }
}
  </textarea>
  <br><br>
  <button onclick="applyScript()">Apply Script</button>
</div>

<div id="shortcuts">
<b>Shortcuts</b><br>
W A S D ‚Äì Move Camera<br>
Right Mouse ‚Äì Look<br>
M ‚Äì Lock / Unlock Mouse<br>
Left Click ‚Äì Select Object<br>
Play ‚Äì Run Scripts
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
/* SCENE */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb); // blue sky

/* CAMERA */
const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0, 6, 12);

/* RENDERER */
const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(innerWidth, innerHeight);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);

/* LIGHTING */
scene.add(new THREE.AmbientLight(0xffffff, 0.5));
const sun = new THREE.DirectionalLight(0xffffff, 1);
sun.position.set(20, 30, 10);
sun.castShadow = true;
scene.add(sun);

/* GRASS BASEPLATE */
const grass = new THREE.Mesh(
  new THREE.BoxGeometry(80, 1, 80),
  new THREE.MeshStandardMaterial({
    color:0x3a8f3a,
    roughness:1
  })
);
grass.position.y = -0.5;
grass.receiveShadow = true;
scene.add(grass);

/* OBJECT SYSTEM */
const objects = [];
let selected = null;
let playing = false;

function addObject(mesh, name) {
  mesh.castShadow = true;
  scene.add(mesh);
  const o = { name, mesh, script:null, code:"", started:false };
  objects.push(o);
  refreshWorkspace();
  return o;
}

function addCube() {
  addObject(
    new THREE.Mesh(
      new THREE.BoxGeometry(1,1,1),
      new THREE.MeshStandardMaterial({ color:0xff5555 })
    ),
    "Cube"
  );
}

function addSphere() {
  addObject(
    new THREE.Mesh(
      new THREE.SphereGeometry(0.5, 32, 32),
      new THREE.MeshStandardMaterial({ color:0x55aaff })
    ),
    "Sphere"
  );
}

addCube();

/* WORKSPACE */
function refreshWorkspace() {
  const w = document.getElementById("workspace");
  w.innerHTML = "";
  objects.forEach(o => {
    const d = document.createElement("div");
    d.className = "item" + (o===selected ? " sel" : "");
    d.textContent = o.name;
    d.onclick = () => select(o);
    w.appendChild(d);
  });
}

function select(o) {
  selected = o;
  document.getElementById("script").value = o.code || document.getElementById("script").value;
  refreshWorkspace();
}

function deleteSelected() {
  if (!selected) return;
  scene.remove(selected.mesh);
  objects.splice(objects.indexOf(selected), 1);
  selected = null;
  refreshWorkspace();
}

/* SCRIPT */
function applyScript() {
  if (!selected) return;
  const code = document.getElementById("script").value;
  const ScriptClass = new Function(code + "; return Script;")();
  selected.script = new ScriptClass();
  selected.code = code;
  selected.started = false;
}

/* MODEL UPLOAD */
document.getElementById("upload").onchange = e => {
  const file = e.target.files[0];
  if (!file) return;
  new THREE.GLTFLoader().load(URL.createObjectURL(file), gltf => {
    addObject(gltf.scene, file.name);
  });
};

/* CAMERA CONTROLS */
const keys = {};
let mouseLocked = false;
let yaw = 0, pitch = 0;

addEventListener("keydown", e => {
  keys[e.key.toLowerCase()] = true;
  if (e.key.toLowerCase() === "m") toggleMouse();
});
addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

function toggleMouse() {
  if (mouseLocked) document.exitPointerLock();
  else renderer.domElement.requestPointerLock();
}

document.addEventListener("pointerlockchange", () => {
  mouseLocked = document.pointerLockElement === renderer.domElement;
});

addEventListener("mousemove", e => {
  if (!mouseLocked) return;
  yaw -= e.movementX * 0.002;
  pitch -= e.movementY * 0.002;
  pitch = Math.max(-1.5, Math.min(1.5, pitch));
});

/* PLAY LOOP */
let last = performance.now();
(function loop(t){
  requestAnimationFrame(loop);
  const dt = (t-last)/1000;
  last = t;

  camera.rotation.set(pitch, yaw, 0, "YXZ");

  if (keys.w) camera.translateZ(-10*dt);
  if (keys.s) camera.translateZ(10*dt);
  if (keys.a) camera.translateX(-10*dt);
  if (keys.d) camera.translateX(10*dt);

  if (playing) {
    objects.forEach(o => {
      if (o.script) {
        if (!o.started) {
          o.script.start?.(o);
          o.started = true;
        }
        o.script.update?.(o, dt);
      }
    });
  }

  renderer.render(scene, camera);
})();
</script>

</body>
</html>

