<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>UNITER ENGINE</title>
<style>
body{margin:0;overflow:hidden;background:#000;font-family:Arial}

/* TOP BAR */
#topbar{
 position:fixed;top:0;left:0;right:0;height:40px;
 background:#1b1b1b;color:white;
 display:flex;align-items:center;padding:0 10px;z-index:10
}
#topbar button{margin-right:6px}

/* LEFT */
#workspacePanel{
 position:fixed;top:40px;left:0;width:220px;bottom:120px;
 background:#141414;color:white;padding:6px;overflow:auto
}
.item{padding:4px;cursor:pointer}
.item.sel{background:#2a7cff}

/* RIGHT */
#scriptPanel{
 position:fixed;top:40px;right:0;width:320px;bottom:120px;
 background:#141414;color:white;padding:6px
}
textarea{
 width:100%;height:100%;background:#0e0e0e;color:#0f0;
 border:1px solid #333;font-family:monospace;font-size:12px
}

/* BOTTOM BAR */
#bottombar{
 position:fixed;left:0;right:0;bottom:0;height:120px;
 background:#1b1b1b;color:white;
 display:flex;align-items:center;justify-content:center;gap:10px
}
.tool{padding:10px 14px;background:#333;cursor:pointer}
.tool.active{background:#2a7cff}

/* SHORTCUTS */
#shortcuts{
 position:fixed;bottom:130px;left:10px;
 background:rgba(20,20,20,.9);
 color:#aaa;font-size:12px;
 padding:8px;border-radius:6px
}

button{background:#2a7cff;border:0;color:white;padding:6px 10px;border-radius:4px}
</style>
</head>
<body>

<div id="topbar">
 <button onclick="play()">▶ Play</button>
 <button onclick="stop()">⏹ Stop</button>
 <button onclick="saveScene()">⬇ Download Scene</button>
 <input type="file" id="upload" accept=".glb,.gltf" />
 <span id="mouseState" style="margin-left:10px">Mouse: Unlocked (M)</span>
</div>

<div id="workspacePanel">
 <b>Workspace</b>
 <div id="workspace"></div>
</div>

<div id="scriptPanel">
 <b>Script</b>
 <textarea id="code">
class Script{
 start(o){}
 update(o,dt){}
}
 </textarea>
 <button onclick="applyScript()">Apply Script</button>
</div>

<div id="bottombar">
 <div class="tool active" onclick="setTool('move')">Move</div>
 <div class="tool" onclick="setTool('rotate')">Rotate</div>
 <div class="tool" onclick="setTool('scale')">Scale</div>
</div>

<div id="shortcuts">
<b>Controls</b><br>
WASD – Move Camera<br>
Right Click – Look<br>
Click – Select<br>
Drag – Transform<br>
M – Lock Mouse
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
/* SCENE */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87a0c0);

/* CAMERA */
const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,.1,1000);
camera.position.set(0,6,10);

/* RENDERER */
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.shadowMap.enabled=true;
document.body.appendChild(renderer.domElement);

/* GRID */
scene.add(new THREE.GridHelper(100,100));

/* LIGHT */
scene.add(new THREE.AmbientLight(0x404040));
const sun=new THREE.DirectionalLight(0xffffff,1.2);
sun.position.set(10,20,10);
sun.castShadow=true;
scene.add(sun);

/* PLATFORM */
const platform=new THREE.Mesh(
 new THREE.BoxGeometry(40,1,40),
 new THREE.MeshStandardMaterial({color:0x2d2d2d})
);
platform.position.y=-.5;
platform.receiveShadow=true;
scene.add(platform);

/* OBJECT SYSTEM */
const objects=[];
let selected=null;
let tool="move";
let playing=false;

/* ADD OBJECT */
function addObject(mesh,name="Object"){
 mesh.castShadow=mesh.receiveShadow=true;
 scene.add(mesh);
 const o={mesh,name,script:null,code:"",started:false};
 objects.push(o);
 refresh();
 return o;
}
addObject(new THREE.Mesh(
 new THREE.BoxGeometry(),
 new THREE.MeshStandardMaterial({color:0xff4444})
),"Cube");

/* WORKSPACE */
function refresh(){
 const w=document.getElementById("workspace");
 w.innerHTML="";
 objects.forEach(o=>{
  const d=document.createElement("div");
  d.className="item"+(o===selected?" sel":"");
  d.textContent=o.name;
  d.onclick=()=>select(o);
  w.appendChild(d);
 });
}
function select(o){
 selected=o;
 document.getElementById("code").value=o.code||document.getElementById("code").value;
 refresh();
}

/* SCRIPT */
function applyScript(){
 if(!selected)return;
 const c=document.getElementById("code").value;
 const C=new Function(c+";return Script;")();
 selected.script=new C();
 selected.code=c;
 selected.started=false;
}

/* UPLOAD MODEL */
document.getElementById("upload").onchange=e=>{
 const f=e.target.files[0];
 if(!f)return;
 const loader=new THREE.GLTFLoader();
 loader.load(URL.createObjectURL(f),g=>{
  const m=g.scene;
  m.position.y=1;
  addObject(m,f.name);
 });
};

/* SAVE */
function saveScene(){
 const data=objects.map(o=>({
  name:o.name,
  pos:o.mesh.position.toArray(),
  rot:o.mesh.rotation.toArray(),
  scale:o.mesh.scale.toArray(),
  script:o.code
 }));
 const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="scene.json";
 a.click();
}

/* INPUT */
let keys={},yaw=0,pitch=0,mouseLocked=false;
addEventListener("keydown",e=>{
 keys[e.key.toLowerCase()]=true;
 if(e.key.toLowerCase()==="m")toggleMouse();
});
addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

function toggleMouse(){
 if(mouseLocked){document.exitPointerLock();mouseLocked=false;}
 else{renderer.domElement.requestPointerLock();mouseLocked=true;}
 document.getElementById("mouseState").textContent=
  "Mouse: "+(mouseLocked?"Locked":"Unlocked")+" (M)";
}

addEventListener("mousemove",e=>{
 if(mouseLocked){
  yaw-=e.movementX*0.002;
  pitch=Math.max(-1.5,Math.min(1.5,pitch-e.movementY*0.002));
 }
});

/* SELECT + TRANSFORM */
let dragging=false;
renderer.domElement.addEventListener("mousedown",e=>{
 if(e.button===0 && selected) dragging=true;
});
addEventListener("mouseup",()=>dragging=false);
addEventListener("mousemove",e=>{
 if(!dragging||!selected)return;
 if(tool==="move"){
  selected.mesh.position.x+=e.movementX*0.02;
  selected.mesh.position.z-=e.movementY*0.02;
 }
 if(tool==="rotate"){
  selected.mesh.rotation.y+=e.movementX*0.01;
 }
 if(tool==="scale"){
  const s=1+e.movementY*0.01;
  selected.mesh.scale.multiplyScalar(s);
 }
});

/* TOOLS */
function setTool(t){
 tool=t;
 document.querySelectorAll(".tool").forEach(b=>b.classList.remove("active"));
 event.target.classList.add("active");
}

/* PLAY */
function play(){playing=true;}
function stop(){playing=false;}

/* LOOP */
let last=performance.now();
(function loop(t){
 requestAnimationFrame(loop);
 const dt=(t-last)/1000;last=t;

 camera.rotation.set(pitch,yaw,0,"YXZ");
 if(!mouseLocked){
  if(keys.w)camera.translateZ(-10*dt);
  if(keys.s)camera.translateZ(10*dt);
  if(keys.a)camera.translateX(-10*dt);
  if(keys.d)camera.translateX(10*dt);
 }

 objects.forEach(o=>{
  if(o.script){
   if(!o.started){o.script.start?.(o);o.started=true;}
   if(playing)o.script.update?.(o,dt);
  }
 });

 renderer.render(scene,camera);
})();
</script>
</body>
</html>
