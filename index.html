<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Web Game Engine</title>

<style>
body {
  margin:0;
  overflow:hidden;
  font-family: Arial, Helvetica, sans-serif;
  background:#2b2b2b;
}

/* TOP BAR */
#topbar {
  position:fixed;
  top:0; left:0; right:0;
  height:40px;
  background:#3c3c3c;
  color:#eee;
  display:flex;
  align-items:center;
  padding:0 10px;
  gap:8px;
  z-index:10;
}

/* LEFT PANEL */
#left {
  position:fixed;
  top:40px; left:0; bottom:0;
  width:220px;
  background:#252526;
  color:#ddd;
  padding:8px;
  overflow:auto;
}

/* RIGHT PANEL */
#right {
  position:fixed;
  top:40px; right:0; bottom:0;
  width:320px;
  background:#252526;
  color:#ddd;
  padding:8px;
}

/* PANELS */
h3 {
  margin:6px 0;
  font-size:13px;
  color:#c8c8c8;
}

.item {
  padding:5px;
  border-radius:4px;
  cursor:pointer;
}
.item:hover { background:#333 }
.item.sel { background:#007acc }

/* SCRIPT */
textarea {
  width:100%;
  height:200px;
  background:#1e1e1e;
  color:#d4d4d4;
  border:1px solid #333;
  font-family: Consolas, monospace;
  font-size:12px;
}

/* BUTTONS */
button {
  background:#0e639c;
  border:none;
  color:white;
  padding:6px 10px;
  border-radius:3px;
  cursor:pointer;
}
button:hover { background:#1177bb }
</style>
</head>

<body>

<div id="topbar">
  <button onclick="play()">Play</button>
  <button onclick="stop()">Stop</button>
  <input type="file" id="upload" accept=".glb,.gltf">
  <span id="mode">Editor</span>
</div>

<div id="left">
  <h3>Workspace</h3>
  <div id="workspace"></div>
</div>

<div id="right">
  <h3>Script (JavaScript)</h3>
  <textarea id="script">
class Script {
  start(o) {
    console.log("Started:", o.name);
  }
  update(o, dt) {
    o.mesh.rotation.y += dt;
  }
}
  </textarea>
  <br><br>
  <button onclick="applyScript()">Apply Script</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
/* SCENE */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xaaaaaa);

/* CAMERA */
const camera = new THREE.PerspectiveCamera(
  70,
  window.innerWidth / window.innerHeight,
  0.1,
  1000
);
camera.position.set(0, 6, 12);

/* RENDERER */
const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);

/* LIGHTING */
scene.add(new THREE.AmbientLight(0xffffff, 0.5));

const sun = new THREE.DirectionalLight(0xffffff, 1);
sun.position.set(10, 20, 10);
sun.castShadow = true;
scene.add(sun);

/* BASEPLATE */
const base = new THREE.Mesh(
  new THREE.BoxGeometry(60, 1, 60),
  new THREE.MeshStandardMaterial({ color:0x6b6b6b })
);
base.position.y = -0.5;
base.receiveShadow = true;
scene.add(base);

/* OBJECT SYSTEM */
const objects = [];
let selected = null;
let playing = false;

function addObject(mesh, name) {
  mesh.castShadow = true;
  scene.add(mesh);
  const o = { name, mesh, script:null, code:"", started:false };
  objects.push(o);
  refreshWorkspace();
  return o;
}

/* DEFAULT CUBE */
addObject(
  new THREE.Mesh(
    new THREE.BoxGeometry(1,1,1),
    new THREE.MeshStandardMaterial({ color:0xff5555 })
  ),
  "Cube"
);

/* WORKSPACE UI */
function refreshWorkspace() {
  const w = document.getElementById("workspace");
  w.innerHTML = "";
  objects.forEach(o => {
    const d = document.createElement("div");
    d.className = "item" + (o === selected ? " sel" : "");
    d.textContent = o.name;
    d.onclick = () => select(o);
    w.appendChild(d);
  });
}

function select(o) {
  selected = o;
  document.getElementById("script").value = o.code || document.getElementById("script").value;
  refreshWorkspace();
}

/* SCRIPT SYSTEM */
function applyScript() {
  if (!selected) return;
  const code = document.getElementById("script").value;
  try {
    const ScriptClass = new Function(code + "; return Script;")();
    selected.script = new ScriptClass();
    selected.code = code;
    selected.started = false;
  } catch (e) {
    alert("Script error:\n" + e.message);
  }
}

/* MODEL UPLOAD (WORKING) */
document.getElementById("upload").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const loader = new THREE.GLTFLoader();
  loader.load(
    URL.createObjectURL(file),
    gltf => {
      const model = gltf.scene;
      model.position.y = 0;
      addObject(model, file.name);
    },
    undefined,
    err => alert("Failed to load model")
  );
});

/* CAMERA CONTROLS */
const keys = {};
let rightMouse = false;
let yaw = 0, pitch = 0;

window.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

renderer.domElement.addEventListener("contextmenu", e => e.preventDefault());
renderer.domElement.addEventListener("mousedown", e => {
  if (e.button === 2) rightMouse = true;
});
window.addEventListener("mouseup", () => rightMouse = false);

window.addEventListener("mousemove", e => {
  if (!rightMouse) return;
  yaw -= e.movementX * 0.002;
  pitch -= e.movementY * 0.002;
  pitch = Math.max(-1.5, Math.min(1.5, pitch));
});

/* LOOP */
let last = performance.now();
function loop(t) {
  requestAnimationFrame(loop);
  const dt = (t - last) / 1000;
  last = t;

  camera.rotation.set(pitch, yaw, 0, "YXZ");

  if (keys.w) camera.translateZ(-10 * dt);
  if (keys.s) camera.translateZ(10 * dt);
  if (keys.a) camera.translateX(-10 * dt);
  if (keys.d) camera.translateX(10 * dt);

  if (playing) {
    objects.forEach(o => {
      if (o.script) {
        if (!o.started) {
          o.script.start?.(o);
          o.started = true;
        }
        o.script.update?.(o, dt);
      }
    });
  }

  renderer.render(scene, camera);
}
loop();

/* PLAY / STOP */
function play() {
  playing = true;
  document.getElementById("mode").textContent = "Play";
}
function stop() {
  playing = false;
  document.getElementById("mode").textContent = "Editor";
}
</script>

</body>
</html>
